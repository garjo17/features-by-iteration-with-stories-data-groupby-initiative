<!DOCTYPE html>
<html>
<head>
    <title>RevisaFeaturesPlus</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("App for Caixabank"),this.pulldownContainer=Ext.create("Ext.container.Container",{id:"pulldown-container-id",layout:{type:"hbox",align:"stretch"}}),this.add(this.pulldownContainer),this._loadIterations()},_loadIterations:function(){this.allUserStories=Ext.create("Ext.Container",{items:[{xtype:"rallycheckboxfield",fieldLabel:"-  All User Stories:",name:"mycheckbox",id:"alluserstories",value:!1,listeners:{change:function(){this._makeStore()},scope:this}}],renderTo:Ext.getBody().dom}),this.iterComboBox=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Iteration",labelAlign:"right",width:370,listeners:{ready:function(){this._makeStore()},select:function(){this._makeStore()},scope:this}}),this.pulldownContainer.add(this.iterComboBox),this.pulldownContainer.add(this.allUserStories)},_makeStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",fetch:["FormattedID","Name","State","Parent","Project","Release","Owner","Description","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","AcceptedLeafStoryCount","LeafStoryCount","ActualEndDate","ActualStartDate","PlannedStartDate","PlannedEndDate"],autoLoad:!0,listeners:{load:this._onDataLoaded,scope:this}})},_onDataLoaded:function(t,e){var a=[],o=e.length;0===e.length&&this._createGrid(a),_.each(e,function(t){var e=0,n=0,r=0,l=0,i=t.get("Release")?t.get("Release")._refObjectName:"None",d=t.get("Project")._refObjectName,s=t.get("State")?t.get("State")._refObjectName:"None",c=(t.get("Name"),{FormattedID:t.get("FormattedID"),Name:t.get("Name"),_ref:t.get("_ref"),Release:i,Project:d,State:s,Iniciative:t.get("Parent")&&t.get("Parent")._refObjectName||"None",Owner:t.get("Owner")&&t.get("Owner")._refObjectName||"None",PercentDoneByStoryCount:t.get("PercentDoneByStoryCount"),PercentDoneByStoryPlanEstimate:t.get("PercentDoneByStoryPlanEstimate"),ActualStartDate:t.get("ActualStartDate"),PlannedStartDate:t.get("PlannedStartDate"),AcceptedLeafStoryCount:t.get("AcceptedLeafStoryCount"),LeafStoryCount:t.get("LeafStoryCount"),PlannedEndDate:t.get("PlannedEndDate"),EstimateTotal:r,ActualTotal:l,RemainingTotal:l,UserStories:[]});t.getCollection("UserStories",{fetch:["FormattedID","ScheduleState","Owner","Iteration","State","Release","Name","TaskActualTotal","TaskEstimateTotal","TaskRemainingTotal"]}).load({callback:function(t){_.each(t,function(t){var a=t.get("Iteration")?t.get("Iteration")._refObjectName:"None",o=t.get("Name"),i=t.get("Project")._refObjectName;n+=t.get("TaskActualTotal"),r+=t.get("TaskEstimateTotal"),l+=t.get("TaskRemainingTotal"),a===this.iterComboBox.getRecord().get("Name")?(e+=1,c.UserStories.push({_ref:t.get("_ref"),FormattedID:t.get("FormattedID"),ScheduleState:t.get("ScheduleState"),Iteration:a,Project:i,Name:o,Owner:t.get("Owner")&&t.get("Owner")._refObjectName||"None",TaskActualTotal:t.get("TaskActualTotal"),TaskEstimateTotal:t.get("TaskEstimateTotal"),TaskRemainingTotal:t.get("TaskRemainingTotal")})):this.down("#alluserstories").getValue()&&c.UserStories.push({_ref:t.get("_ref"),FormattedID:t.get("FormattedID"),ScheduleState:t.get("ScheduleState"),Iteration:a,Project:i,Name:o,Owner:t.get("Owner")&&t.get("Owner")._refObjectName||"None",TaskActualTotal:t.get("TaskActualTotal"),TaskEstimateTotal:t.get("TaskEstimateTotal"),TaskRemainingTotal:t.get("TaskRemainingTotal")})},this),0!==e&&(c.EstimateTotal=r,c.ActualTotal=n,c.RemainingTotal=l,a.push(c)),0==--o&&this._createGrid(a)},scope:this})},this)},_createGrid:function(t){var e=Ext.create("Rally.data.custom.Store",{data:t,pageSize:100,remoteSort:!1,groupField:"Iniciative"});this.down("#fgrid")?this.down("#fgrid").reconfigure(e):this.add({xtype:"rallygrid",itemId:"fgrid",store:e,features:[{ftype:"groupingsummary"}],columnCfgs:[{text:"ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name"},{text:"Project(team)",dataIndex:"Project"},{text:"Owner",dataIndex:"Owner"},{xtype:"templatecolumn",text:"Planned Start Date",tpl:Ext.create("Rally.ui.renderer.template.DateTemplate",{fieldName:"PlannedStartDate"})},{xtype:"templatecolumn",text:"Planned End Date",tpl:Ext.create("Rally.ui.renderer.template.DateTemplate",{fieldName:"PlannedEndDate"})},{xtype:"templatecolumn",text:"% Done by Story Count",dataIndex:"PercentDoneByStoryCount",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryCountTemplate")},{xtype:"templatecolumn",text:"% Done by Story Points Count",dataIndex:"PercentDoneByStoryPlanEstimate",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate")},{text:"US Accepted",dataIndex:"AcceptedLeafStoryCount"},{text:"US Totales",dataIndex:"LeafStoryCount"},{text:"Feature Release",dataIndex:"Release"},{text:"Hours Estimate",dataIndex:"EstimateTotal"},{text:"Hours Actual",dataIndex:"ActualTotal"},{text:"Hours Remaining",dataIndex:"RemainingTotal"},{text:"User Stories",dataIndex:"UserStories",flex:1,renderer:function(t){var e=[];return e.push('<table class="tb" style=""><style>.tb { border-collapse: collapse; }.tb th, .tb td { padding: 2px; border: solid 1px #777; }.tb th { background-color: lightblue; }</style><thead><tr><th> Link-ID </th><th> Name </th><th> State </th><th> Iteration </th><th> Estimate </th><th> Actual </th><th> Remainin </th></tr></head><tbody>'),_.each(t,function(t){e.push('<tr> <td><a href="#" onclick=Rally.nav.Manager.showDetail("'+t._ref+'") )><img src="https://rally1.rallydev.com/slm/images/icon_edit.gif"></a><b> '+t.FormattedID+"</a></b></td><td>"+t.Name+"</td><td>"+t.ScheduleState+"</td><td>"+t.Iteration+"</td><td>"+t.TaskEstimateTotal+"</td><td>"+t.TaskActualTotal+"</td><td>"+t.TaskRemainingTotal+"</td></tr>")}),e.push("</tbody></table>"),e}}]})}});

            Rally.launchApp('CustomApp', {
                name:"RevisaFeaturesPlus",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
